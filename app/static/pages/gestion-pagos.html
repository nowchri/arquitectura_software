<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión de Pagos - Academia Trazos & Latices</title>
    <script src="https://kit.fontawesome.com/668c4bf34c.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../stylepages.css">
    <link rel="icon" type="image/x-icon" href="../imgs/logo_main.ico">
</head>

<body>
    <div class="dashboard-wrapper">
        <div id="sidebar-placeholder"></div>
        <main>
            <header>
                <h1>Gestión de Pagos</h1>
                <div class="profile">
                    <span class="profile__role">Gerente</span>
                    <div class="profile__avatar">
                        <img src="../imgs/img-admin.webp" alt="Perfil Gerente">
                        <!--<img src="../imgs/gerente.jpg" alt="Perfil Gerente">-->
                        <span class="profile__status" aria-hidden="true"></span>
                    </div>
                </div>
            </header>
            <!-- Contenido principal -->
            <section class="content content--listado">
                <form class="toolbar" role="search">
                    <div class="field">
                        <label for="pago-documento">Documento:</label>
                        <input type="text" id="pago-documento" placeholder="Ingresa número de documento">
                    </div>
                    <button type="submit" class="btn-primary">Buscar</button>
                </form>
                <div class="table-wrapper" style="max-height: 400px; overflow-y: auto;">
                    <table class="students-table">
                        <thead>
                            <tr>
                                <th>Estudiante</th>
                                <th>Detalle Pago</th>
                                <th class="col-action">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="pagos-tbody"></tbody>
                    </table>
                </div>
                <div class="actions">
                    <a href="registro-estudiantes.html" class="btn-primary btn-primary--large">Volver</a>
                </div>
            </section>
            <!-- Modal para detalle de pago -->
            <div id="modal-pago" class="modal">
                <div class="modal-content perfil-modal-flex">
                    <div class="perfil-form" id="detalle-pago-modal" style="width:100%;"></div>
                    <span class="close-modal" id="cerrar-modal-pago">&times;</span>
                </div>
            </div>

    <script>
        function mostrarDetallePago(pago) {
    let html = `
        <div style="flex:1;">
            <h3>Estudiante</h3>
            <b>${pago.nombre_estudiante} (${pago.documento_estudiante})</b>
            <hr>
            <h3>Pago</h3>
            <ul>
                <li><b>Tipo:</b> ${pago.tipo}</li>
                <li><b>Monto:</b> $${pago.monto}</li>
                <li><b>Método de pago:</b> ${pago.metodo_pago}</li>
                <li><b>Fecha:</b> ${pago.fecha}</li>
                <li><b>Estado:</b> ${pago.estado}</li>
            </ul>
    `;
    if (pago.tipo === "bastidor") {
        html += `<h4>Bastidor</h4>
                <ul><li><b>Medidas:</b> ${pago.bastidor_medidas || "N/A"}</li></ul>`;
    } else if (pago.tipo === "mensualidad") {
        html += `<h4>Plan de Clases</h4>
            <ul>
                <li><b>Nombre:</b> ${pago.plan_nombre || "N/A"}</li>
                <li><b>Número de clases/mes:</b> ${pago.plan_numero_clases || "N/A"}</li>
            </ul>`;
    } else { // inscripción
        html += `<b>Plan:</b> N/A<br><b>Bastidor:</b> N/A<br>`;
    }
    html += "</div>";
    document.getElementById('detalle-pago-modal').innerHTML = html;
    document.getElementById('modal-pago').classList.add('modal--open');
}

function pintarPagos(pagos) {
    const tbody = document.getElementById("pagos-tbody");
    tbody.innerHTML = "";
    if (pagos.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="3" style="text-align:center;color:#c44;">No se encontraron pagos.</td>`;
        tbody.appendChild(tr);
        return;
    }
    pagos.forEach(pago => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>
                ${pago.nombre_estudiante} <br>
                <small>Cédula: ${pago.documento_estudiante}</small>
            </td>
            <td>
                ${pago.tipo} - $${pago.monto} <br>
                <small>Método: ${pago.metodo_pago}</small>
            </td>
            <td>
                <a href="#" class="link-action ver-pago-btn" data-id="${pago.id_pago}">Ver pago</a>
            </td>
        `;
        tbody.appendChild(tr);
    });
    document.querySelectorAll('.ver-pago-btn').forEach(btn => {
        btn.onclick = function(e) {
            e.preventDefault();
            const id = this.getAttribute("data-id");
            // Si quieres pedir el pago al backend por /api/pagos/{id_pago},
            // puedes hacerlo aquí, pero como ya tenemos toda la info, buscamos local
            const pago = pagos.find(p => p.id_pago == id);
            mostrarDetallePago(pago);
        };
    });
}

// Cerrar modal
document.getElementById('cerrar-modal-pago').onclick = function() {
    document.getElementById('modal-pago').classList.remove('modal--open');
};

// Buscar pagos
function cargarPagos(documento=null) {
    let url = "/api/pagos/";
    if (documento) url += "?documento=" + encodeURIComponent(documento);
    fetch(url)
        .then(res => res.json())
        .then(json => pintarPagos(json));
}
cargarPagos();

document.querySelector(".toolbar").addEventListener("submit", function (e) {
    e.preventDefault();
    const doc = document.getElementById("pago-documento").value.trim();
    cargarPagos(doc);
});
    </script>
    <script src="scripts/menu-loader.js"></script>
</body>

</html>